{% extends "base.html" %}
{% block title %}Profile | PhysiHome{% endblock %}
{% block content %}
<section class="profile-card card" data-pending-verification="{{ 'true' if pending_verification else 'false' }}">
  <header class="auth-header">
    <div class="profile-avatar">
      <img src="{{ profile_avatar_url }}" alt="Profile avatar" />
    </div>
    <h1>{{ profile.name }}</h1>
    {% if profile.gender %}
    <span class="badge">{{ profile.gender|title }}</span>
    {% endif %}
  </header>

  {% if profile.pending_verification %}
  <div class="alert warn">
    Your doctor verification is pending. We will complete it within 12 hours. Thank you.
  </div>
  {% endif %}

  {% if location_updated %}
  <div class="alert success">Practice location updated successfully.</div>
  {% elif location_error %}
  <div class="alert error">Could not update your practice location. Please enter a city and a valid PIN.</div>
  {% endif %}

  {% if documents_updated %}
  <div class="alert success">Documents uploaded. {% if reverify_notice %}We will re-verify your degree shortly.{% endif %}</div>
  {% elif documents_error %}
  <div class="alert error">Upload at least one document to update your profile.</div>
  {% endif %}

  {% if reverify_notice and not documents_updated %}
  <div class="alert warn">Degree replacements trigger re-verification. Our team will review and update your status soon.</div>
  {% endif %}

  <div class="profile-grid-header">
    <h2 class="sr-only">Profile details</h2>
    <div></div>
    <button class="icon-btn" type="button" aria-label="Edit profile information" data-profile-edit>&#9998;</button>
  </div>

  <div class="profile-grid">
    <div>
      <p class="label">Email</p>
      <p>{{ profile.email }}</p>
    </div>
    <div>
      <p class="label">Contact</p>
      <p>{{ profile.contact }}</p>
    </div>
    <div>
      <p class="label">Date of birth</p>
      <p>{{ profile.dob }}</p>
    </div>
    {% if is_doctor and profile.city %}
    <div>
      <p class="label">City</p>
      <p>{{ profile.city }}</p>
    </div>
    {% endif %}
    {% if is_doctor and profile.preferred_pin %}
    <div>
      <p class="label">Preferred PIN</p>
      <p>{{ profile.preferred_pin }}</p>
    </div>
    {% endif %}
    {% if profile.specialization %}
    <div>
      <p class="label">Specialization</p>
      <p>{{ profile.specialization }}</p>
    </div>
    {% endif %}
    {% if profile.doctor_verification_status %}
    <div>
      <p class="label">Doctor verification</p>
      <p>{{ profile.doctor_verification_status }}</p>
    </div>
    {% endif %}
  </div>

  {% if self_photo_url or degree_photo_url or visiting_card_url %}
  <div class="profile-docs">
    <div class="profile-docs-header">
      <h2>Uploaded documents</h2>
      {% if is_doctor %}
      <button class="icon-btn" type="button" aria-label="Update documents" data-docs-edit>&#9998;</button>
      {% endif %}
    </div>
    <div class="doc-grid">
      {% if self_photo_url %}
      <figure class="doc-card">
        <button class="doc-thumb" type="button" data-zoom-src="{{ self_photo_url }}" data-zoom-label="Self photo">
          <img src="{{ self_photo_url }}" alt="Self photo" />
          <span class="doc-thumb-action">Zoom</span>
        </button>
        <figcaption>Self photo</figcaption>
      </figure>
      {% endif %}
      {% if degree_photo_url %}
      <figure class="doc-card">
        <button class="doc-thumb" type="button" data-zoom-src="{{ degree_photo_url }}" data-zoom-label="Degree certificate">
          <img src="{{ degree_photo_url }}" alt="Degree document" />
          <span class="doc-thumb-action">Zoom</span>
        </button>
        <figcaption>Degree certificate</figcaption>
      </figure>
      {% endif %}
      {% if visiting_card_url %}
      <figure class="doc-card">
        <button class="doc-thumb" type="button" data-zoom-src="{{ visiting_card_url }}" data-zoom-label="Visiting card">
          <img src="{{ visiting_card_url }}" alt="Visiting card" />
          <span class="doc-thumb-action">Zoom</span>
        </button>
        <figcaption>Visiting card</figcaption>
      </figure>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <dialog id="profileEditDialog" class="modal">
    <div class="modal-body">
      <div class="modal-header">
        <h2>Edit profile</h2>
        <form method="dialog">
          <button class="lightbox-close" type="submit" aria-label="Close">&times;</button>
        </form>
      </div>
      <form class="stack" method="post" action="/api/auth/update-profile">
        <div class="form-grid two-col">
          <label>
            First name
            <input type="text" name="first_name" value="{{ current_user.first_name or '' }}" required />
          </label>
          <label>
            Last name
            <input type="text" name="last_name" value="{{ current_user.last_name or '' }}" required />
          </label>
        </div>
        <label>
          Contact
          <input type="text" name="phone" value="{{ current_user.phone or '' }}" required />
        </label>
        <label>
          Email
          <input type="email" name="email" value="{{ current_user.email or '' }}" required />
          <span class="helper">Changing email requires OTP verification.</span>
        </label>
        {% if is_doctor %}
        <div class="form-grid two-col">
          <label>
            City
            <input type="text" name="city" value="{{ profile.city or '' }}" required />
          </label>
          <label>
            Preferred PIN code
            <input type="text" name="preferred_pin" inputmode="numeric" pattern="\d{3,6}" value="{{ profile.preferred_pin or '' }}" required />
          </label>
        </div>
        {% endif %}
        <div class="modal-actions">
          <button class="btn primary" type="submit">Save changes</button>
          <button class="btn secondary" type="button" data-dialog-close>Cancel</button>
        </div>
      </form>
    </div>
  </dialog>

  {% if is_doctor %}
  <dialog id="documentsEditDialog" class="modal">
    <div class="modal-body">
      <div class="modal-header">
        <h2>Update documents</h2>
        <form method="dialog">
          <button class="lightbox-close" type="submit" aria-label="Close">&times;</button>
        </form>
      </div>
      <p class="muted">Add replacements for any document. If you change your degree certificate, verification resets to pending until we verify again.</p>
      <form class="stack" method="post" action="/api/auth/doctor/update-documents" enctype="multipart/form-data">
        <label>
          Self photo (optional)
          <input type="file" name="self_photo" accept="image/*" />
        </label>
        <label>
          Degree certificate (triggers re-verification)
          <input type="file" name="degree_photo" accept="image/*,.pdf" />
        </label>
        <label>
          Visiting card
          <input type="file" name="visiting_card" accept="image/*,.pdf" />
        </label>
        <div class="modal-actions">
          <button class="btn primary" type="submit">Upload updates</button>
          <button class="btn secondary" type="button" data-dialog-close>Cancel</button>
        </div>
      </form>
    </div>
  </dialog>
  {% endif %}

  <dialog id="pendingVerificationDialog" class="modal">
    <div class="modal-body">
      <h2>Verification in progress</h2>
      <p>Your profile verification will be completed within 12 hours. Thank you.</p>
      <form method="dialog">
        <button class="btn primary" type="submit">Got it</button>
      </form>
    </div>
  </dialog>
</section>
{% endblock %}
