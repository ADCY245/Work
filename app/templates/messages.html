{% extends "base.html" %}
{% block title %}Messages | PhysiHome{% endblock %}
{% block content %}
<section class="messages-board">
  <div class="messages-header">
    <div>
      <p class="eyebrow">Secure inbox</p>
      <h1>Stay in sync with your care team</h1>
      <p class="muted">Send updates, share progress photos, and keep every instruction in one place.</p>
    </div>
    <a class="btn secondary" href="/messages/start-admin">Any issues? Contact admin</a>
  </div>

  <div style="display:grid; grid-template-columns: 320px 1fr; gap: 1rem;">
    <div class="card" style="padding: 1rem;" data-threads-panel>
      <h3 style="margin-top:0;">Inbox</h3>
      {% if threads and threads|length %}
        <div class="threads" style="margin-top: 0.75rem; display:flex; flex-direction:column; gap:0.5rem;" data-threads-list>
          {% for thread in threads %}
            <a class="card" style="padding:0.75rem; text-decoration:none;" href="/messages/{{ thread._id }}" data-thread-item data-thread-id="{{ thread._id }}" data-thread-unread="{{ 1 if thread.unread_count and thread.unread_count > 0 else 0 }}">
              <strong style="display:block; color: inherit;">{{ thread.title }}</strong>
              <span class="muted small">Open conversation</span>
              {% if thread.unread_count and thread.unread_count > 0 %}
              <span class="badge" style="margin-left:0.5rem;" data-thread-unread-badge>{{ thread.unread_count }}</span>
              {% endif %}
            </a>
          {% endfor %}
        </div>
      {% else %}
        <p class="muted">No messages yet.</p>
        <a class="btn primary" href="/messages/start-admin">Any issues? Contact admin</a>
      {% endif %}
    </div>

    <div class="card" style="padding: 1rem;" data-conversation-panel data-active-thread-id="{{ conversation._id if conversation else '' }}">
      {% if conversation %}
        <div style="display:flex; justify-content:space-between; align-items:center; gap:0.75rem;">
          <h3 style="margin:0;">Conversation</h3>
          <a class="btn secondary" href="/messages">Back</a>
        </div>
        <div style="margin-top: 0.75rem; display:flex; flex-direction:column; gap:0.5rem; max-height: 52vh; overflow:auto;" data-messages-list>
          {% for msg in messages %}
            {% if msg.is_me %}
            <div style="display:flex; justify-content: flex-end;" data-created-at="{{ msg.created_at }}">
            {% else %}
            <div style="display:flex; justify-content: flex-start;" data-created-at="{{ msg.created_at }}">
            {% endif %}
              <div class="card" style="padding:0.6rem 0.75rem; max-width: 70%;">
                <div style="white-space: pre-wrap;">{{ msg.text }}</div>
              </div>
            </div>
          {% endfor %}
          {% if not messages or messages|length == 0 %}
            <p class="muted">No messages yet. Send the first one.</p>
          {% endif %}
        </div>
        <form method="post" action="/messages/{{ conversation._id }}/send" style="margin-top: 0.75rem; display:flex; gap:0.5rem;" data-send-form>
          <input name="text" type="text" placeholder="Type a message" style="flex:1;" />
          <button class="btn primary" type="submit">Send</button>
        </form>
      {% else %}
        <h3 style="margin-top:0;">Select a conversation</h3>
        <p class="muted" data-no-chat>Tap chats to read.</p>
      {% endif %}
    </div>
  </div>
</section>
{% endblock %}
